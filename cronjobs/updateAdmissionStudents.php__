<?php

require_once("../include/dbsetting/lms_vars_config.php");
require_once("../include/dbsetting/classdbconection.php");
require_once("../include/functions/functions.php");
$dblms = new dblms();


$sqllmsAdmissionStudents = $dblms->querylms("SELECT inq.*
                                                FROM ".ADMISSIONS_INQUIRY." inq
                                                INNER JOIN ".FEES." f ON f.inquiry_formno = inq.form_no
                                                WHERE NOT EXISTS(
                                                                    SELECT s.std_id
                                                                    FROM ".STUDENTS." s
                                                                    WHERE s.admission_formno = inq.form_no
                                                                    AND s.is_deleted = '0'
                                                                )
                                                AND f.status        = '1'
                                                AND f.id_type       = '1'
                                                AND f.is_deleted    = '0'
                                                AND inq.is_deleted  = '0'
                                            ");
while($row = mysqli_fetch_array($sqllmsAdmissionStudents)) {

    // Date Conversion
    $admissiondate = date('Y-m-d');
    $admission_year = date('Y');

    //For Campus Short Code
    $sqllmsCampus = $dblms->querylms("SELECT campus_code 
                                        FROM ".CAMPUS." 
                                        WHERE campus_id = '".cleanvars($row['id_campus'])."' 
                                        LIMIT 1
                                    ");
    $valueCampus = mysqli_fetch_array($sqllmsCampus);
    $campus_code = $valueCampus['campus_code'];

    // For Class Code
    $sqllmsClass = $dblms->querylms("SELECT class_code 
                                        FROM ".CLASSES." 
                                        WHERE class_id = '".cleanvars($row['id_class'])."' 
                                        LIMIT 1
                                    ");
    $valueClass = mysqli_fetch_array($sqllmsClass);

    if($row['id_session'] == '0'){
        // For Current Admission Session
        $sqllmsSession = $dblms->querylms("SELECT se.session_id
                                                FROM ".SESSIONS." se
                                                INNER JOIN ".SETTINGS." st ON st.adm_session = se.session_id
                                                WHERE se.session_status = '1' 
                                                AND st.status = '1' 
                                                AND st.is_deleted != '1' 
                                                LIMIT 1
                                            ");
        $valueSession = mysqli_fetch_array($sqllmsSession);
        $id_session   = $valueSession['session_id'];

    }else{
        $id_session   = $row['id_session'];
    }

    

    //Roll No 
    $newRollno = 0;
    $sqllmsRoll	= $dblms->querylms("SELECT MAX(std_rollno) as rollno
                                    FROM ".STUDENTS."
                                    WHERE id_campus = '".$row['id_campus']."'
                                    AND id_class    = '".$row['id_class']."'");
    if(mysqli_num_rows($sqllmsRoll) > 0 ){
        $valueRoll = mysqli_fetch_array($sqllmsRoll);
        (int)$valueRoll['rollno'];
        $newRollno = (int)$valueRoll['rollno'] + 1;
    }
    else{
        $newRollno = 1;
    }

	//---------------- Reg No -----------------
    $chkregno = $admission_year.'-'.$campus_code.'-';
    $sqllmsCheck	= $dblms->querylms("SELECT std_id, std_regno
                                                FROM ".STUDENTS."
                                                WHERE std_regno LIKE '".$chkregno."%'
                                                ORDER BY std_regno DESC LIMIT 1");
    if(mysqli_num_rows($sqllmsCheck)>0){
        $valueCheck = mysqli_fetch_array($sqllmsCheck);
        $regno = $valueCheck['std_regno'];
        $regno++;
    }else{
        $regno = $admission_year.'-'.$campus_code.'-000001';
    }
    // Remove Spaces
    $regno = str_replace(" ","", $regno);

    // Insert Student
    $sqllms  = $dblms->querylms("INSERT INTO ".STUDENTS."(
                                                          std_status 
                                                        , std_name
                                                        , std_fathername  
                                                        , std_gender  
                                                        , id_guardian  
                                                        , std_dob  
                                                        , id_country 
                                                        , std_nic   
                                                        , std_phone 
                                                        , std_address
                                                        , is_orphan 
                                                        , is_hostelized 
                                                        , id_class   
                                                        , id_session  
                                                        , std_rollno  
                                                        , std_regno  
                                                        , admission_formno
                                                        , std_admissiondate
                                                        , id_campus
                                                        , id_added  
                                                        , date_added															
                                                    )
                                                VALUES(
                                                          '1' 
                                                        , '".cleanvars($row['name'])."'
                                                        , '".cleanvars($row['fathername'])."'
                                                        , '".cleanvars($row['gender'])."' 
                                                        , '".cleanvars($row['guardian'])."' 
                                                        , '".cleanvars($row['dob'])."'
                                                        , '1' 
                                                        , '".cleanvars($row['nic'])."' 
                                                        , '".cleanvars($row['cell_no'])."' 
                                                        , '".cleanvars($row['address'])."' 
                                                        , '".cleanvars($row['is_orphan'])."' 
                                                        , '".cleanvars($row['is_hostelized'])."' 
                                                        , '".cleanvars($row['id_class'])."' 
                                                        , '".cleanvars($id_session)."' 
                                                        , '".cleanvars($newRollno)."' 
                                                        , '".cleanvars($regno)."' 
                                                        , '".cleanvars($row['form_no'])."' 
                                                        , '".$admissiondate."' 
                                                        , '".cleanvars($row['id_campus'])."'
                                                        , '4'
                                                        , NOW()
                                                    )");  
                                                   
    $std_id = $dblms->lastestid();  
			
    // Enrolled In Hostel
    if($row['is_hostelized'] == '1'){

        $sqllmsHostel = $dblms->querylms("INSERT INTO ".HOSTEL_REG."(
                                                            status 
                                                        , id_std
                                                        , joining_date 
                                                        , id_campus
                                                        , id_added
                                                        , date_added
                                                    )
                                                VALUES(
                                                            '1' 
                                                        , '".cleanvars($std_id)."'
                                                        , '".cleanvars($admissiondate)."'
                                                        , '".cleanvars($row['id_campus'])."'
                                                        , '4'
                                                        , Now()
                                                    )" );
    }

    // Make Login
    // password salt
    $salt = dechex(mt_rand(0, 2147483647)) . dechex(mt_rand(0, 2147483647));

    // Password
    $pass = 'ags786';

    // hash password
    $password = hash('sha256', $pass . $salt);
    for($round = 0; $round < 65536; $round++) {
        $password = hash('sha256', $password . $salt);
    }

    // Insert
    $sqllmsLogin  = $dblms->querylms("INSERT INTO ".ADMINS."(
                                                      adm_status  
                                                    , adm_type
                                                    , adm_logintype 
                                                    , adm_username 
                                                    , adm_salt
                                                    , adm_userpass
                                                    , adm_fullname
                                                    , adm_phone
                                                    , id_campus
                                                    , id_added
                                                    , date_added
                                                )
                                            VALUES(
                                                        '1'
                                                    , '0'
                                                    , '5'
                                                    , '".cleanvars($regno)."'
                                                    , '".cleanvars($salt)."'
                                                    , '".cleanvars($password)."'
                                                    , '".cleanvars($row['name'])."'
                                                    , '".cleanvars($row['cell_no'])."'
                                                    , '".cleanvars($row['id_campus'])."'
                                                    , '4'
                                                    , Now()	
                                                )");
			
    // Update LogoinID
    $adm_id = $dblms->lastestid();
    
    $sqllmsLoginID = $dblms->querylms("UPDATE ".STUDENTS." SET  
                                                        id_loginid	= '".$adm_id."'  
                                                    WHERE std_id	= '".$std_id."'");
}
?>